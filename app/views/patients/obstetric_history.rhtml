
<html>
  <head>
    <script type="text/javascript" language="javascript">
      <!--
      tt_cancel_show = "/patients/show/<%= @patient.id %>";
      tt_cancel_destination = "/patients/show/<%= @patient.id %>";
      var deliveries = 0;
      var max_delivered = 1;
      var parity;
      var parsedConceptName;
      var data = {};
<%
session_date = session[:datetime]? session[:datetime] : Date.today
%>
  var anc_visits = <%= @anc_patient.anc_visits(session_date).to_json%>;

  anc_visits.push("zero");
  var parsedConceptName = "Visit Number";

  //-->

  function readableMessage(){

    var conceptName = conceptHash[tstCurrentPage]
    conceptName = (parsedConceptName && parsedConceptName.length > 1) ? parsedConceptName : conceptName;
    conceptName = (conceptName.toLowerCase() == "parity")? "Number of Pregnancies" : conceptName;

    try{
      conceptName = conceptName.charAt(0).toUpperCase() + conceptName.slice(1).toLowerCase();
      if(__$("messageBar") && !__$("messageBar").innerHTML.match(conceptName)){
        __$("messageBar").innerHTML = __$("messageBar").innerHTML.replace("Value", conceptName + " Value").replace("value", conceptName + " value").replace("a " + conceptName + " value", conceptName + " value")
      }
    }catch(ex){}

    setTimeout(function(){ readableMessage()}, 50);
  }

  function buildConceptsHash(){
    var count = 0;
    var inputArr = document.getElementsByTagName("input")
    conceptHash = {};
    for (var i = 0; i < inputArr.length; i ++){
      if (inputArr[i].name && inputArr[i].name.match("concept_name") && inputArr[i].name.match("observations")){
        conceptHash[count] = inputArr[i].value;
        count ++;
      }
    }
  }

  function transformMessages(){
    buildConceptsHash();
    setTimeout(function(){ readableMessage()}, 50);
  }

  function updateMultiplePregnancy(){

    if (max_delivered == 2){
      __$("multiple_pregnancy").value = "Twins"
    }else if(max_delivered == 3){
      __$("multiple_pregnancy").value = "Triplets"
    }else if(max_delivered == 4){
      __$("multiple_pregnancy").value = "Quadruplet"
    }else if(max_delivered == 1){
      __$("multiple_pregnancy").value = "No"
    }

  }

  function updateParity(num){
    par = 0;
    for (i = 1; i <= num; i ++){
      try{
        if (parseInt(__$('gestation_type' + i).value) > 0){
          par = par + parseInt(__$("gestation_type" + i).value);
        }
      }catch(ex){
      }
    }
    parity = par;
    __$('enter_number_of_deliveries').value = "";
    __$('enter_number_of_deliveries').value = parity;
  }

  function updateDeliveries(){
    deliveries = __$('enter_number_of_deliveries').value;
  }

  function updateVariables(num){
    max_delivered = 1;
    for (i = 1; i <= num; i ++){
      if (__$("gestation_type" + i).value > max_delivered){
        max_delivered = __$("gestation_type" + i).value;
      }
    }
  }

  function validateInput(preg, baby_no){

    if (baby_no > 1){

      var twin_baby_year = __$("year_of_birth" + preg + "" + (baby_no - 1)).value;

      if (!twin_baby_year.toString().match(/unknown/i)){

        __$("touchscreenInput" + tstCurrentPage).setAttribute("min", twin_baby_year);

        __$("touchscreenInput" + tstCurrentPage).setAttribute("absoluteMin", twin_baby_year);

        __$("touchscreenInput" + tstCurrentPage).setAttribute("max", twin_baby_year);

        __$("touchscreenInput" + tstCurrentPage).setAttribute("absoluteMax", (parseInt(twin_baby_year) + 1));

      }
    }

    __$("year_of_birth" + preg + (baby_no - 1)).value = "";

  }

  function loadSelections(){
    __$("keyboard").style.display = "none";
    __$("touchscreenInput" + tstCurrentPage).style.display = "none";
    __$("inputFrame" + tstCurrentPage).style.height = "72vh";
    __$("inputFrame" + tstCurrentPage).style.marginTop = "5vh";
    __$("inputFrame" + tstCurrentPage).style.background = "white";

    var pregnancies = __$("enter_gravida").value;
    var delivered_pregnancies = __$("enter_number_of_deliveries").value;
    var aborted_pregnancies = __$("enter_number_of_abortions").value;

        
    if (delivered_pregnancies > 0){
          
      var headerHolder = document.createElement("div");
      headerHolder.style.height = "8vh";
      headerHolder.style.width = "100%";
      headerHolder.style.borderRadius = "10px";
                   
      var header = document.createElement("div");
      header.id = "header";
      header.style.width = "100%";
      headerHolder.appendChild(header);

      var t1 = document.createElement("div");
      t1.innerHTML = "Pregnancy";
      t1.setAttribute("class", "h-cell");
      header.appendChild(t1);

      var t2 = document.createElement("div");
      t2.innerHTML = "Baby count";
      t2.setAttribute("class", "h-cell");
      header.appendChild(t2);

      var t3 = document.createElement("div");
      t3.innerHTML = "Details available?";
      t3.setAttribute("class", "h-cell");
      header.appendChild(t3);

      __$("inputFrame" + tstCurrentPage).appendChild(headerHolder);

      var container = document.createElement("div");
      container.id = "container";
          
      __$("inputFrame" + tstCurrentPage).appendChild(container);
      var table = document.createElement("div");
      table.id = "table";
         
      container.appendChild(table);

      for (var p = 1; p <= delivered_pregnancies; p ++ ){
        var row = document.createElement("div");
        row.setAttribute("class", "data-row");
        row.id = "row_" + p;
        if (p % 2 == 1){
          row.style.background = "#F8F8F8";
        }

        var cell1 = document.createElement("div");
        cell1.id = "cell_" + p + "_1";
        cell1.style.paddingLeft = "15%";
        cell1.setAttribute("class", "data-cell");
        cell1.innerHTML = p + (p == 1 ? "<sup>st</sup>" : ((p == 2 ? "<sup>nd</sup>" : (p == 3 ? "<sup>rd</sup>" : "<sup>th</sup>"))));
        row.appendChild(cell1);

        var cell2 = document.createElement("div");
        cell2.id = "cell_" + p + "_2";
        cell2.setAttribute("class", "data-cell");
        cell2.innerHTML = "<button class = 'minus' onmousedown = 'decrement(" +p+")'></button> <input id = 'input_"+ p +"'  value = '1' class = 'label' id = 'label"+ p + "' >  </input> <button class = 'plus' onmousedown = 'increment("+ p +")'></button>"
        row.appendChild(cell2);

        var cell3 =  document.createElement("div");
        cell3.id = "cell_" + p + "_3";
        cell3.setAttribute("class", "data-cell-img");
        cell3.innerHTML = '<img id = "img_' + p +'" onclick = "checkSelection(' + p + ')" src="/images/unticked.jpg" height="45" width="45"> ';
        row.appendChild(cell3);

        data[p] = {};
        data[p]["condition"] = false;
        data[p]["count"] = 1;
        table.appendChild(row);
           
      }

      var width  = __$("row_1").offsetWidth + "px";
      headerHolder.style.width = width;
      header.style.width = width;
      updateInput(1, false);
    }
  }

  function increment(pos){
        
    if (parseInt( __$("input_" + pos).value) <= 7){

      __$("input_" + pos).value = parseInt( __$("input_" + pos).value) + 1;
      updateInput(pos);
    }
  }

  function decrement(pos){

    if (parseInt( __$("input_" + pos).value) > 1){

      __$("input_" + pos).value = parseInt( __$("input_" + pos).value) - 1;
      updateInput(pos);
    }
  }

  function checkSelection(pos){

    if (__$("img_" + pos).src.match(/unticked/)){
          
      __$("img_" + pos).src = "/images/ticked.jpg";
      updateInput(pos, true);
    }else{

      __$("img_" + pos).src = "/images/unticked.jpg";
      updateInput(pos, false);
    }
  }

  function updateInput(pos, bool){
        
    if (data[pos] == undefined){
          
      data[pos] = {};
    }
        
    data[pos]["count"] = parseInt( __$("input_" + pos).value);

    if (bool != undefined)
      data[pos]["condition"] = bool;
       
    __$("data").value = stringfy(data);
  }

  function stringfy(hash){
        
    var keys = Object.keys(hash);
    var vals = "{";
    var cons = "{";
        
    for (var i = 0; i < keys.length; i ++){

      vals += keys[i] + " => ";
      cons += keys[i] + " => ";
          
      if (i != keys.length - 1){

        vals += data[keys[i]]["count"] + ", ";
        cons += data[keys[i]]["condition"] + ", ";
      } else {

        vals += data[keys[i]]["count"] + "}";
        cons += data[keys[i]]["condition"] + "}";
      }
    }

    var string = "{'values' => " + vals + ", 'conditions' => " + cons + "}";
      
    return string;
  }

  function disablePastVisits(){
    for(var i = 0; i < anc_visits.length; i++){
      if(__$(anc_visits[i])){
        __$(anc_visits[i]).className = "keyboardButton gray";
        __$(anc_visits[i]).onmousedown = function(){}
      }
    }
  }

  function calculateAbortions(){
       updateDeliveries();
  	if ( __$('enter_gravida').value > 1 ){
  	    __$('enter_number_of_abortions').value = parseInt(__$('enter_gravida').value) - parseInt(__$('enter_number_of_deliveries').value) -1	
  	}
  }

  //setTimeout("disablePastVisits()", 200);

    </script>

    <style>
      #table, #header {
        display: table;
        table-layout:fixed;
        -moz-user-select: none;
      }

      #table{
        width: 100%;
      }

      #container {
        height: 63vh;
        width: 100%;
        margin-top: 1vh;
        overflow: auto;
        border-radius: 10px;
      }

      .h-cell{
        display: table-cell;
        width: 30%;
        font-style: bold;
        vertical-align: middle;
        height: 8vh;
        font-size: 25px;
        text-align: center;
        border-radius: 5px;
        border-width: 1px;
        border-color: lightgray;
        border-style: solid;
        background: #66CCFF;
      }
      .data-row{
        display: table-row;
        width: 100%;

      }

      .data-cell{
        display: table-cell;
        width: 33%;
        margin: 5px;
        height: 9vh;
        padding-left: 10%;
        vertical-align: middle;
        font-size: 26px;
        border-bottom: solid 1px gray;
        border-right: solid 1px gray;
      }

      .plus, .plus:hover {
        background: url('/images/up_arrow.png');
        background-repeat:no-repeat;
        height: 90%;
        border-width: 0px;
        border-style: hidden;
        outline: none;
        -moz-outline : none;
      }

      .minus, .minus:hover {
        background: url('/images/down_arrow.png');
        background-repeat:no-repeat;
        height: 90%;
        border-style: hidden;
        border-width: 0px;
        outline: none;
        -moz-outline: none;
      }

      .label {
        font-size: 27px;
        background: #E6E6E6;
        width: 45px !important;
        margin-top: 10px;
        margin-right: 20px;
        border-width: 3.5px;
        border-color: #8ABEA1;
        text-align: center;
        -moz-user-select: none;
      }

      .data-cell-img {
        width: 33%;
        display: table-cell;
        background-repeat:no-repeat;
        border-bottom: solid 1px gray;
      }

      .data-cell-img img{
        float: right;
        height: 90%;
        margin-top: 10px;
        padding-right: 50%;
      }

    </style>
  </head>
  <body>
    <% form_tag :controller => "patients", :action => "obstetric_counts" do |f| %>


      <%= hidden_field_tag "patient_id", @patient.id %>
      <%= hidden_field_tag "with_visit_type", params[:with_visit_type] %>

      <%= hidden_field_tag "data", nil,
        {
        :id => 'data'
      }%>

     <%  if params[:with_visit_type] && params[:with_visit_type].to_s == "true" %>
        <%= hidden_field_tag "encounter[encounter_type_name]", "ANC VISIT TYPE" %>
        <%= hidden_field_tag "encounter[patient_id]", @patient.id %>
        <%= hidden_field_tag "encounter[encounter_datetime]", session[:datetime]? session[:datetime] : DateTime.now() %>
        <%= hidden_field_tag "encounter[provider_id]", session[:user_id] %>


        <%= hidden_field_tag("programs[][patient_program_id]", @program_id) %>
        <%= hidden_field_tag("programs[][program_id]", Program.find_by_name('ANC PROGRAM').id)%>
        <%= hidden_field_tag("programs[][location_id]", Location.current_health_center.id) %>
        <%= hidden_field_tag("programs[][date_enrolled]", session[:datetime] || Date.today ) %>
        <%= hidden_field_tag("programs[][states][][state]", "Currently in treatment") %>


        <%= touch_numeric_tag "Type of visit", @patient, nil,
          {
          :id => "visit",
          :helptext => "ANC visit number <span class='helper'> Obstetric History</span>",
          :tt_onLoad => "document.forms[0].reset(); disablePastVisits(); transformMessages();",
          :tt_pageStyleClass => "NumbersOnly",
          :max => 7,
          :min => 1
        } %>
      <%
      end

      if  @obs_present != true && @current_user_activities.include?('obstetric history')
      %>

        <%= touch_numeric_tag "GRAVIDA", @patient, nil,
          {:id => "enter_gravida",
          :helptext => "Gravida <span class='helper'> Obstetric History</span>",
          :absoluteMin => 0,
          :max => 20,
          :min => 1,
          :tt_onLoad => "transformMessages();",
          :tt_onUnLoad => "if(__$('category')){__$('content').removeChild(__$('category'))}
      if(__$('enter_gravida').value == 1){
      __$('enter_number_of_abortions').value = 0;
      };",
          :tt_pageStyleClass => "NumbersOnly"} %>

        <%= touch_numeric_tag "PARITY", @patient, nil,
          {:id => "enter_number_of_deliveries",
          :helptext => "Enter Number Of Delivered Pregnancies <span class='helper'> Obstetric History</span>",
          :tt_pageStyleClass => "NumbersWithUnknown",
          :condition => "__$('enter_gravida').value > 1",
          :tt_onLoad => " __$('touchscreenInput' + " +
            "tstCurrentPage).setAttribute('absoluteMax', (__$('enter_gravida').value - 1))",
          :tt_onUnLoad => "if(__$('enter_number_of_deliveries').value == 0){
      }; __$('enter_number_of_abortions').setAttribute('absoluteMax', (parseInt(__$('enter_gravida').value - parseInt(__$('enter_number_of_deliveries').value) -1 )));
      __$('enter_number_of_abortions').setAttribute('absoluteMin', (parseInt(__$('enter_gravida').value - parseInt(__$('enter_number_of_deliveries').value) -1 )));
      __$('enter_number_of_abortions').setAttribute('validationRule', '[' + (parseInt(__$('enter_gravida').value) -
      parseInt(__$('enter_number_of_deliveries').value) - 1) + ']');
      __$('enter_number_of_abortions').setAttribute('validationMessage', 'Expected value is ' + (parseInt(__$('enter_gravida').value) -
      parseInt(__$('enter_number_of_deliveries').value) - 1));
      __$('enter_number_of_abortions').removeAttribute('validationRule'); " +
            "__$('enter_number_of_abortions').removeAttribute('validationMessage');calculateAbortions();"
        } %>

        <%= touch_numeric_tag "NUMBER OF ABORTIONS", @patient, nil,
          {:id => "enter_number_of_abortions",
          :helptext => "Enter Number Of Abortions <span class='helper'> Obstetric History</span>",
          :tt_pageStyleClass => "NumbersWithUnknown",
          :condition => "false",
          :tt_onLoad => "updateDeliveries(); ",
          # :min => 0,
          # :max => 5,
          :validationRule => "[0-5]",
          :validationMessage => "Check your value"
        } %>

        <%= touch_text_field_tag "known pregnancies", @patient, nil,
          {:id => "known_pregnancies",
          :helptext => "Select pregnancies with available information <span class='helper'> Obstetric History</span>",
          :tt_onLoad => "loadSelections();",
          :optional => "true",
          :condition => "__$('enter_gravida').value > 1"
        } %>
      <%end%>
      <%= submit_tag 'Finish' %>
    <% end %>
  </body>
</html>
