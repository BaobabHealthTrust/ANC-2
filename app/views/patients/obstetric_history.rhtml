
<html>
  <head>

    <script src="/javascripts/jquery-1.3.2.min.js" type="text/javascript"></script>
    <script src="/javascripts/obstetric_history.js" type="text/javascript"></script>
    <script>


      tt_cancel_show = "/patients/show/<%= @patient.id %>";
      tt_cancel_destination = "/patients/show/<%= @patient.id %>";
      var deliveries = 0;
      var max_delivered = 1;
      var parity;
      var parsedConceptName;
      var data = {};
<%session_date = session[:datetime]? session[:datetime] : Date.today%>
  var anc_visits = <%= @anc_patient.anc_visits(session_date).to_json%>;
  var birth_year = <%= @birth_year.to_i%>;
  var max_birth_year = <%= @max_birth_year.to_i%>;
  var min_birth_year = <%= @min_birth_year.to_i%>;
  var abs_max_birth_year = <%= @abs_max_birth_year.to_i%>;
  var current_popup = "Enter Value";

  var hash = {
    "TBA" : "T.B.A",
    "Spontaneous vaginal delivery" : "S.V.D",
    "Caesarean Section" : "C.S",
    "Vacuum Extraction Delivery" : "V.E.D",
    "Big Baby (Above 4kg)" : "> 4kg",
    "Small Baby (Less than 2.5kg)" : "< 2.5kg"
  }

  var fields = ["Year of birth", "Place of birth",
    "Gestation (months)", "Method of delivery",
    "Condition at birth", "Birth weight",
    "Alive Now"];
 
  anc_visits.push("zero");
  var parsedConceptName = "Visit Number";

  
    </script>
    <%= stylesheet_link_tag "obstetric_history" %>
  </head>
  <body>
    <% form_tag :controller => "patients", :action => "obstetric_counts" do |f| %>


      <%= hidden_field_tag "patient_id", @patient.id %>
      <%= hidden_field_tag "with_visit_type", params[:with_visit_type] %>

      <%= hidden_field_tag "data", nil,
        {
        :id => 'data'
      }%>
    <%= hidden_field_tag "data_obj", nil,
        {
        :id => 'data_obj'
      }%>

      <%  if params[:with_visit_type] && params[:with_visit_type].to_s == "true" %>
        <%= hidden_field_tag "encounter[encounter_type_name]", "ANC VISIT TYPE" %>
        <%= hidden_field_tag "encounter[patient_id]", @patient.id %>
        <%= hidden_field_tag "encounter[encounter_datetime]", session[:datetime]? session[:datetime] : DateTime.now() %>
        <%= hidden_field_tag "encounter[provider_id]", session[:user_id] %>


        <%= hidden_field_tag("programs[][patient_program_id]", @program_id) %>
        <%= hidden_field_tag("programs[][program_id]", Program.find_by_name('ANC PROGRAM').id)%>
        <%= hidden_field_tag("programs[][location_id]", Location.current_health_center.id) %>
        <%= hidden_field_tag("programs[][date_enrolled]", session[:datetime] || Date.today ) %>
        <%= hidden_field_tag("programs[][states][][state]", "Currently in treatment") %>


        <%= touch_numeric_tag "Type of visit", @patient, nil,
          {
          :id => "visit",
          :helptext => "ANC visit number <span class='helper'> Obstetric History</span>",
          :tt_onLoad => "document.forms[0].reset(); disablePastVisits();",
          :tt_pageStyleClass => "NumbersOnly",
          :max => 7,
          :min => 1
        } %>
      <%
      end

      if  @obs_present != true && @current_user_activities.include?('obstetric history')
      %>

        <%= touch_numeric_tag "GRAVIDA", @patient, nil,
          {:id => "enter_gravida",
          :helptext => "Gravida <span class='helper'> Obstetric History</span>",
          :absoluteMin => 0,
          :max => 20,
          :min => 1,
          :tt_onUnLoad => "if(__$('category')){__$('content').removeChild(__$('category'))}
      if(__$('enter_gravida').value == 1){
      __$('enter_number_of_abortions').value = 0;
      };",
          :tt_pageStyleClass => "NumbersOnly"} %>

        <%= touch_numeric_tag "PARITY", @patient, nil,
          {:id => "enter_number_of_deliveries",
          :helptext => "Enter Number Of Delivered Pregnancies <span class='helper'> Obstetric History</span>",
          :tt_pageStyleClass => "NumbersWithUnknown",
          :condition => "__$('enter_gravida').value > 1",
          :tt_onLoad => " __$('touchscreenInput' + " +
            "tstCurrentPage).setAttribute('absoluteMax', (__$('enter_gravida').value - 1))",
          :tt_onUnLoad => "if(__$('enter_number_of_deliveries').value == 0){
      }; __$('enter_number_of_abortions').setAttribute('absoluteMax', (parseInt(__$('enter_gravida').value - parseInt(__$('enter_number_of_deliveries').value) -1 )));
      __$('enter_number_of_abortions').setAttribute('absoluteMin', (parseInt(__$('enter_gravida').value - parseInt(__$('enter_number_of_deliveries').value) -1 )));
      __$('enter_number_of_abortions').setAttribute('validationRule', '[' + (parseInt(__$('enter_gravida').value) -
      parseInt(__$('enter_number_of_deliveries').value) - 1) + ']');
      __$('enter_number_of_abortions').setAttribute('validationMessage', 'Expected value is ' + (parseInt(__$('enter_gravida').value) -
      parseInt(__$('enter_number_of_deliveries').value) - 1));
      __$('enter_number_of_abortions').removeAttribute('validationRule'); " +
            "__$('enter_number_of_abortions').removeAttribute('validationMessage');calculateAbortions();"
        } %>

        <%= touch_numeric_tag "NUMBER OF ABORTIONS", @patient, nil,
          {:id => "enter_number_of_abortions",
          :helptext => "Enter Number Of Abortions <span class='helper'> Obstetric History</span>",
          :tt_pageStyleClass => "NumbersWithUnknown",
          :condition => "false",
          :validationRule => "[0-5]",
          :validationMessage => "Check your value"
        } %>

        <%= touch_text_field_tag "", @patient, nil,
          {:id => "known_pregnancies",
          :helptext => "Select pregnancies with available information <span class='helper'> Obstetric History</span>",
          :tt_onLoad => "loadSelections(); jQuery('.dcimg').click();",
          :optional => "true",
          :condition => "__$('enter_gravida').value > 1 && __$('enter_number_of_deliveries').value > 0"
        } %>

        <%= touch_text_field_tag "", @patient, nil,
          {:id => "input_page",
          :helptext => "Enter pregnancy details <span class='helper'> Obstetric History</span>",
          :tt_onLoad => "parsedConceptName = ''; loadInputWindow();",
          :tt_BeforeUnLoad => "buildParams()",
          :optional => "true",
          :condition => "__$('enter_gravida').value > 1 && __$('enter_number_of_deliveries').value > 0"
        } %>
      <%end%>
      <%= submit_tag 'Finish' %>
    <% end %>
  </body>
</html>
